<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Auth - Home</title>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f7f9fc; }
    .card { max-width:700px; margin:auto; background:#fff; padding:28px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { text-align:center; color:#222; }
    .row { margin:12px 0; display:flex; gap:10px; align-items:center; }
    button { padding:10px 14px; border:0; border-radius:6px; cursor:pointer; }
    #connectButton { background:#1e88e5; color:#fff; }
    #registerButton { background:#43a047; color:#fff; }
    #authButton { background:#ffb300; color:#222; }
    #deactivateButton { background:#ef5350; color:#fff; }
    .status { padding:10px; border-radius:6px; margin-bottom:10px; }
    .ok { background:#e8f5e9; color:#1b5e20; border:1px solid #c8e6c9; }
    .err { background:#ffebee; color:#b71c1c; border:1px solid #ffcdd2; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Privacy-Preserving Auth — Portal</h1>

    <div id="status" class="status err">Status: Wallet Disconnected.</div>
    <div class="row">
      <div style="flex:1;">Current Account: <strong id="currentAccount">N/A</strong></div>
      <div>Network: <strong id="networkName">N/A</strong></div>
    </div>

    <div class="row">
      <button id="connectButton" onclick="connectWallet()">Connect MetaMask</button>
      <button id="disconnectButton" onclick="disconnect()" style="display:none;">Disconnect</button>
    </div>

    <hr />
    <h3>Registration & Authentication</h3>
    <div class="row">
      <button id="registerButton" onclick="registerUser()">Register</button>
      <button id="authButton" onclick="authenticateUser()">Authenticate (Login)</button>
      <button id="deactivateButton" onclick="deactivateAccount()">Deactivate My Account</button>
    </div>
    <div id="registerMessage" class="status" style="display:none;"></div>
    <div id="authMessage" class="status" style="display:none;"></div>

    <hr />
    <h3>Profile</h3>
    <div>
      <label>Profile CID (IPFS) or public pointer</label>
      <input id="profileCid" type="text" placeholder="Qm..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
      <div class="row"><button onclick="setProfileCid()">Save Profile CID</button></div>
      <div id="profileMessage" class="status" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ⚠️ PASTE YOUR *NEW* AuthManager CONTRACT ADDRESS HERE
    const CONTRACT_ADDRESS = "0xbeD37d9132FB40Ff93Ba0F2F9840C6ceBa8C7EB1";
    
    // MODIFIED: Added logAccess and UserAccess event
    const CONTRACT_ABI = [
      "function register() public",
      "function deactivateAccount() public",
      "function authenticate(address user) external view returns (bool)",
      "function setProfileCID(string calldata cid) external",
      "function isRegistered(address user) external view returns (bool)",
      "function logAccess() external", // NEW function
      "event UserAccess(address indexed user, uint256 timestamp)" // NEW event
    ];

    let provider, signer, contract, currentAccount;

    function el(id){ return document.getElementById(id); }
    function showStatus(t, ok=true){ el('status').textContent='Status: '+t; el('status').className='status '+(ok?'ok':'err'); }
    function showMsg(id,t,ok=true){ const m=el(id); m.style.display='block'; m.textContent=t; m.className='status '+(ok?'ok':'err'); setTimeout(()=>m.style.display='none',5000); }

    async function connectWallet(){
      if(!window.ethereum){showStatus('MetaMask not installed',false);return;}
      provider=new ethers.providers.Web3Provider(window.ethereum);await provider.send("eth_requestAccounts",[]);
      signer=provider.getSigner();currentAccount=await signer.getAddress();
      contract=new ethers.Contract(CONTRACT_ADDRESS,CONTRACT_ABI,signer);
      const n=await provider.getNetwork();el('currentAccount').textContent=currentAccount;el('networkName').textContent=n.name;showStatus('Connected',true);
      el('connectButton').style.display='none';el('disconnectButton').style.display='inline-block';
    }
    
    function disconnect(){provider=null;signer=null;contract=null;currentAccount=null;el('currentAccount').textContent='N/A';el('networkName').textContent='N/A';showStatus('Disconnected',false);el('connectButton').style.display='inline-block';el('disconnectButton').style.display='none';}
    
    async function registerUser(){if(!contract){showMsg('registerMessage','Connect wallet first',false);return;}try{const tx=await contract.register();showMsg('registerMessage','Confirm registration in MetaMask...');await tx.wait();showMsg('registerMessage','Registered successfully!');}catch(e){showMsg('registerMessage', e.error?.message || e.message || 'Registration failed.',false);}}
    
    // MODIFIED: Calls logAccess after successful authentication check
    async function authenticateUser(){
      if(!contract){showMsg('authMessage','Connect wallet first',false);return;}
      
      try {
        // 1. Check if registered (view call, free)
        const isAuth = await contract.authenticate(currentAccount);
        
        if(isAuth){
          // 2. If registered, send the logAccess transaction (costs gas)
          showMsg('authMessage','Authenticated! Logging your access...', true);
          const tx = await contract.logAccess(); // Call the logging function
          await tx.wait(); // Wait for the logging transaction to be mined
          
          // 3. Redirect
          showMsg('authMessage','Access logged! Redirecting to dashboard...', true);
          setTimeout(()=>window.location.href='dashboard.html', 1500); // Redirect after logging
        
        } else {
          // User is not registered
          showMsg('authMessage','Authentication Failed: User not registered.',false);
        }
      } catch (e) {
          // Handle errors from authenticate check OR logAccess transaction
          console.error("Authentication or Logging Error:", e);
          showMsg('authMessage', e.error?.message || e.message || 'Authentication or logging failed.', false);
      }
    }
    
    async function deactivateAccount(){if(!contract){showMsg('registerMessage','Connect wallet first',false);return;}try { const tx=await contract.deactivateAccount(); showMsg('registerMessage', 'Confirm deactivation in MetaMask...'); await tx.wait(); showMsg('registerMessage','Account deactivated successfully.');} catch(e) { showMsg('registerMessage', e.error?.message || e.message || 'Deactivation failed.', false); }}
    
    async function setProfileCid(){if(!contract){showMsg('profileMessage','Connect wallet first',false);return;}const cid=el('profileCid').value.trim();if(!cid){showMsg('profileMessage','Please enter a Profile CID or pointer.',false);return;}try{const tx=await contract.setProfileCID(cid); showMsg('profileMessage', 'Confirm saving profile CID in MetaMask...'); await tx.wait();showMsg('profileMessage','Profile CID saved successfully!');} catch(e) {showMsg('profileMessage', e.error?.message || e.message || 'Failed to save Profile CID.',false);}}

    // Add event listeners for MetaMask account/network changes
    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', (accounts) => {
            // If account changed, disconnect and require re-connect
            if (accounts.length === 0) {
              disconnect();
            } else {
              // Reload page or re-run connectWallet to update UI
              window.location.reload(); 
            }
        });
        window.ethereum.on('chainChanged', (chainId) => {
            // Reload page on network change
            window.location.reload();
        });
    }

  </script>
</body>
</html>