<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organization Secure Communication</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background-color: #f4f6fb;
      color: #2f3640;
    }
    header {
      background-color: #273c75;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .container {
      padding: 30px;
      max-width: 900px;
      margin: 0 auto;
    }
    .section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .section h2 {
      color: #273c75;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .message-box {
      background-color: #f0f4ff;
      border-left: 4px solid #40739e;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .secret {
      background-color: #ffeaa7;
      border-left: 4px solid #e1b12c;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 600;
    }
    .announcement {
      background-color: #dff9fb;
      border-left: 4px solid #00a8ff;
      padding: 10px 15px;
      border-radius: 8px;
    }
    .chat-input {
      display: flex;
      margin-top: 15px;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      font-size: 14px;
    }
    .chat-input button {
      background-color: #273c75;
      color: white;
      border: none;
      padding: 10px 15px;
      margin-left: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .chat-input button:hover {
      background-color: #40739e;
    }
    footer {
      text-align: center;
      padding: 15px;
      color: #7f8fa6;
      font-size: 13px;
    }
    .logout-btn, .admin-btn {
      display: block;
      background-color: #c23616;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      margin: 20px auto 10px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }
    .admin-btn {
        background-color: #273c75;
        margin-bottom: 20px;
    }
    .logout-btn:hover {
      background-color: #e84118;
    }
    .admin-btn:hover {
        background-color: #40739e;
    }
    /* Blockchain Wall */
    #public-wall {
      background: #ffffff;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }
    #postList .post-item {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #fff;
    }
  </style>
</head>
<body>
  <header>üîí Secure Organization Portal</header>

  <div class="container">
    <div class="section">
      <h2>Welcome to the Secure Intranet</h2>
      <p>
        This platform is for internal communication and data exchange between verified members of the organization.
        All activities are encrypted and logged on-chain for transparency.
      </p>
    </div>

    <button class="admin-btn" onclick="window.location.href='admin.html'">
        Admin Management üîê
    </button>

    <div class="section">
      <h2>üîê Confidential Communications</h2>
      <div class="message-box">
        <strong>Admin:</strong> Meeting scheduled at 10:00 AM tomorrow. Only project leads should attend.
      </div>
      <div class="message-box">
        <strong>Security:</strong> New access policy will be rolled out next week. Please review your key permissions.
      </div>
      <div class="secret">
        üî∏ Secret Transmission: "Operation Eclipse" deployment key rotation planned for 18th Oct 2025.
      </div>
    </div>

    <div class="section">
      <h2>üì¢ Internal Announcements</h2>
      <div class="announcement">
        üéØ System maintenance on 15 Oct, 22:00 UTC ‚Äî expect temporary downtime of decentralized nodes.
      </div>
      <div class="announcement">
        üí° Remember to back up your personal encryption keys before next login cycle.
      </div>
    </div>

    <div class="section">
      <h2>üí¨ Send Secure Message</h2>
      <div id="chatArea"></div>
      <div class="chat-input">
        <input id="msgInput" type="text" placeholder="Type your secure message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- ü™ô PUBLIC BLOCKCHAIN WALL -->
    <div id="public-wall">
      <h2>üåê University Public Wall</h2>

      <div id="walletArea">
        <button id="connectButton">Connect Wallet</button>
        <span id="walletAddr" style="margin-left:10px;"></span>
      </div>

      <div id="postComposer" style="margin-top:12px; display:none;">
        <textarea id="postInput" placeholder="Share what you have done..." style="width:100%;height:80px;padding:8px"></textarea>
        <br/>
        <button id="postButton">Post on Blockchain</button>
        <span id="postingStatus" style="margin-left:10px"></span>
      </div>

      <div id="postList" style="margin-top:16px;">
        <!-- Posts load here -->
      </div>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <footer>¬© 2025 Confidential | Authorized Personnel Only</footer>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js"></script>

  <script>
    // Existing chat
    function sendMessage() {
      const msg = document.getElementById("msgInput").value.trim();
      if (!msg) return;
      const box = document.createElement("div");
      box.className = "message-box";
      box.innerHTML = `<strong>You:</strong> ${msg}`;
      document.getElementById("chatArea").appendChild(box);
      document.getElementById("msgInput").value = "";
    }

    function logout() {
      alert("Logging out and returning to login page...");
      window.location.href = "index.html";
    }

    // -------------------- BLOCKCHAIN WALL --------------------
    const CONTRACT_ADDRESS = "0xB8e7594f21d3093ce18B274ddF1288E87273c3d3"; // Replace with your deployed contract address

    const ABI = [
      "function addPost(string _text) external",
      "function getPostCount() view returns (uint256)",
      "function getPost(uint256 index) view returns (address author, string text, uint256 timestamp)",
      "event PostCreated(uint256 indexed index, address indexed author, uint256 timestamp, string text)"
    ];

    let provider, signer, contract;

    const connectButton = document.getElementById("connectButton");
    const walletAddrSpan = document.getElementById("walletAddr");
    const postComposer = document.getElementById("postComposer");
    const postButton = document.getElementById("postButton");
    const postInput = document.getElementById("postInput");
    const postList = document.getElementById("postList");
    const postingStatus = document.getElementById("postingStatus");

    async function init() {
      if (typeof window.ethereum === "undefined") {
        connectButton.innerText = "Install MetaMask";
        connectButton.onclick = () => window.open("https://metamask.io/");
        return;
      }
      provider = new ethers.BrowserProvider(window.ethereum);
      connectButton.onclick = connectWallet;
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
      await loadPosts();
    }

    async function connectWallet() {
      try {
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        const addr = await signer.getAddress();
        walletAddrSpan.textContent = addr;
        connectButton.style.display = "none";
        postComposer.style.display = "block";
        contract = contract.connect(signer);

        const eventFilter = contract.filters.PostCreated();
        contract.on(eventFilter, (index, author, timestamp, text) => {
          prependPost({ author, text, timestamp: Number(timestamp) });
        });
      } catch (err) {
        console.error(err);
        alert("MetaMask connection failed.");
      }
    }

    postButton.addEventListener("click", async () => {
      const message = postInput.value.trim();
      if (!message) return alert("Please enter something to post.");
      try {
        postingStatus.textContent = "Posting...";
        const tx = await contract.addPost(message);
        await tx.wait();
        postingStatus.textContent = "Posted ‚úî";
        postInput.value = "";
        setTimeout(() => (postingStatus.textContent = ""), 2000);
      } catch (err) {
        console.error(err);
        postingStatus.textContent = "Failed ‚ùå";
        setTimeout(() => (postingStatus.textContent = ""), 2000);
      }
    });

    async function loadPosts() {
      postList.innerHTML = "<p>Loading posts...</p>";
      try {
        const count = Number(await contract.getPostCount());
        postList.innerHTML = "";
        for (let i = count - 1; i >= 0; i--) {
          const [author, text, ts] = await contract.getPost(i);
          appendPostToUI({ author, text, timestamp: Number(ts) });
        }
        if (count === 0) postList.innerHTML = "<p>No posts yet. Be the first!</p>";
      } catch (err) {
        console.error(err);
        postList.innerHTML = "<p>Unable to load posts. Is Ganache running?</p>";
      }
    }

    function appendPostToUI({ author, text, timestamp }) {
      const d = new Date(timestamp * 1000);
      const el = document.createElement("div");
      el.className = "post-item";
      el.innerHTML = `<div style="font-size:0.9em;color:#444;margin-bottom:6px;">
        <strong>${shortAddr(author)}</strong> ‚Ä¢ ${d.toLocaleString()}
        </div>
        <div style="white-space:pre-wrap;">${escapeHtml(text)}</div>`;
      postList.appendChild(el);
    }

    function prependPost({ author, text, timestamp }) {
      const d = new Date(timestamp * 1000);
      const el = document.createElement("div");
      el.className = "post-item";
      el.innerHTML = `<div style="font-size:0.9em;color:#444;margin-bottom:6px;">
        <strong>${shortAddr(author)}</strong> ‚Ä¢ ${d.toLocaleString()}
        </div>
        <div style="white-space:pre-wrap;">${escapeHtml(text)}</div>`;
      postList.prepend(el);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function shortAddr(a) {
      return a ? a.slice(0, 6) + "..." + a.slice(-4) : "";
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
